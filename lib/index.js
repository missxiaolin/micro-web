let list=[];const getList=()=>list,setList=t=>list=t;let lifecycle$1={};const getMainLifecycle=()=>lifecycle$1,setMainLifecycle=t=>lifecycle$1=t,patchRouter=(t,e)=>function(){const n=new Event(e);t.apply(this,arguments),window.dispatchEvent(n)},currentApp=()=>{const t=window.location.pathname;return filterApp("activeRule",t)},findAppByRoute=t=>filterApp("activeRule",t),filterApp=(t,e)=>{const n=getList().filter((n=>n[t]===e));return n&&n.length?n[0]:{}},isTurnChild=()=>{const{pathname:t}=window.location;let e=t.match(/(\/\w+)/);if(e&&(e=e[0]),window.__ORIGIN_APP__=window.__CURRENT_SUB_APP__,window.__CURRENT_SUB_APP__===e)return!1;const n=window.location.pathname.match(/(\/\w+)/);return n?(window.__CURRENT_SUB_APP__=n[0],!0):void 0},fetchResource=t=>fetch(t).then((async t=>await t.text())),performScriptForEval=(script,appName,global)=>{window.proxy=global;const scriptText=`\n    ((window) => {\n      ${script}\n      return window['${appName}'] \n    })(window.proxy)\n  `;return eval(scriptText)};let defaultValue={};class ProxySandbox{constructor(){this.proxy=null,this.active()}active(){this.proxy=new Proxy(window,{get:(t,e)=>"function"==typeof t[e]?t[e].bind(t):defaultValue[e]||t[e],set:(t,e,n)=>(defaultValue[e]=n,!0)})}inactive(){defaultValue={}}}const isCheckLifeCycle=t=>t&&t.bootstrap&&t.mount&&t.unmount,sandBox=(t,e)=>{const n=new ProxySandbox;t.proxy||(t.proxy=n),window.__MICRO_WEB__=!0;const o=performScriptForEval(e,t.name,t.proxy.proxy);isCheckLifeCycle(o)&&(t.bootstrap=o.bootstrap,t.mount=o.mount,t.unmount=o.unmount)},cache={},loadHtml=async t=>{let e=t.container,n=t.entry;const[o,a]=await parseHtml(n,t.name),i=document.querySelector(e);if(!i)throw new Error("容器不存在");return i.innerHTML=o,a.forEach((e=>{sandBox(t,e)})),t},parseHtml=async(t,e)=>{if(cache[e])return cache[e];const n=await fetchResource(t);let o=[];const a=document.createElement("div");a.innerHTML=n;const[i,r,c]=await getResources(a,t),s=await Promise.all(r.map((async t=>fetchResource(t))));return o=c.concat(s),cache[e]=[i,o],[i,o]},getResources=async(t,e)=>{const n=[],o=[],a=t.outerHTML;return function t(a){const i=a.children,r=a.parent;if("script"===a.nodeName.toLowerCase()){const t=a.getAttribute("src");t?t.startsWith("http")?n.push(t):n.push(`http:${e}/${t}`):o.push(a.outerHTML),r&&r.replaceChild(document.createComment("此 js 文件已经被微前端替换"),a)}if("link"===a.nodeName.toLowerCase()){const t=a.getAttribute("href");t.endsWith(".js")&&(t.startsWith("http")?n.push(t):n.push(`http:${e}/${t}`))}for(let e=0;e<i.length;e++)t(i[e])}(t),[a,n,o]},lifecycle=async()=>{const t=findAppByRoute(window.__ORIGIN_APP__),e=findAppByRoute(window.__CURRENT_SUB_APP__);if(!e)return;t&&t.unmount&&(t.proxy&&t.proxy.inactive(),await destroyed(t));const n=await beforeLoad(e);await mounted(n)},beforeLoad=async t=>{await runMainLifeCycle("beforeLoad"),t&&t.bootstrap&&t.bootstrap(t);const e=await loadHtml(t);return e&&e.beforeLoad&&e.beforeLoad(),e},mounted=async t=>{t&&t.mount&&t.mount(t),await runMainLifeCycle("mounted")},destroyed=async t=>{t&&t.unmount&&t.unmount(t),await runMainLifeCycle("destroyed")},runMainLifeCycle=async t=>{const e=getMainLifecycle();await Promise.all(e[t].map((async t=>await t())))},turnApp=async()=>{isTurnChild()&&await lifecycle()},rewriteRouter=()=>{window.history.pushState=patchRouter(window.history.pushState,"micro_push"),window.history.replaceState=patchRouter(window.history.replaceState,"micro_replace"),window.addEventListener("micro_push",turnApp),window.addEventListener("micro_replace",turnApp),window.onpopstate=async function(){await turnApp()}};class Custom{on(t,e){window.addEventListener(t,(t=>{e(t.detail)}))}emit(t,e){const n=new CustomEvent(t,{detail:e});window.dispatchEvent(n)}}const prefetch=async()=>{const t=getList().filter((t=>!window.location.pathname.startsWith(t.activeRule)));await Promise.all(t.map((async t=>await parseHtml(t.entry,t.name))))},custom=new Custom;window.microCustom=custom,rewriteRouter();const registerMicroApps=(t,e)=>{setList(t),setMainLifecycle(e)},start=()=>{if(!getList().length)throw Error("子应用列表为空，请正确注册");const t=currentApp();if(t){const{pathname:e,hash:n}=window.location,o=e+n;window.__CURRENT_SUB_APP__=t.activeRule,window.history.pushState("","",o)}prefetch()},createStore=(t={})=>(()=>{let e=t;const n=[];return{getStore:()=>e,update:t=>{if(t!==e){const o=e;e=t,n.forEach((async t=>await t(e,o)))}},subscribe:t=>{n.push(t)}}})();export{createStore,registerMicroApps,start};
//# sourceMappingURL=index.js.map
